<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produkter - Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        .product-table {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        td, th {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .product-image-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 2rem;
            border-radius: 8px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
    </style>
</head>
<body>
    <nav class="container-fluid">
        <ul>
            <li><strong>üîê Admin Panel</strong></li>
        </ul>
        <ul>
            <li><a href="/admin/dashboard.html">Dashboard</a></li>
            <li><a href="/admin/products.html">Produkter</a></li>
            <li><a href="/admin/articles.html">Artikler</a></li>
            <li><a href="/admin/orders.html">Bestillinger</a></li>
            <li><a href="#" onclick="logout()">Logg ut</a></li>
        </ul>
    </nav>

    <main class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Produkter</h1>
            <button onclick="openProductModal()">‚ûï Nytt produkt</button>
        </div>

        <div class="product-table">
            <table id="products-table">
                <thead>
                    <tr>
                        <th>Bilde</th>
                        <th>Navn</th>
                        <th>Kategori</th>
                        <th>Pris (NOK)</th>
                        <th>Beholdning</th>
                        <th>Status</th>
                        <th>Handlinger</th>
                    </tr>
                </thead>
                <tbody id="products-tbody">
                    <tr><td colspan="7" style="text-align: center;">Laster produkter...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Product Edit Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeProductModal()">&times;</span>
            <h2 id="modal-title">Nytt produkt</h2>
            
            <form id="product-form">
                <input type="hidden" id="product-id">
                
                <div class="grid">
                    <label>
                        Produktnavn *
                        <input type="text" id="product-name" required>
                    </label>

                    <label>
                        Slug (URL-vennlig) *
                        <input type="text" id="product-slug" required pattern="[a-z0-9-]+">
                        <small>Bare sm√• bokstaver, tall og bindestrek</small>
                    </label>
                </div>

                <label>
                    Beskrivelse
                    <textarea id="product-description" rows="4"></textarea>
                </label>

                <div class="grid">
                    <label>
                        Pris (NOK) *
                        <input type="number" id="product-price" step="0.01" min="0" required>
                    </label>

                    <label>
                        Beholdning *
                        <input type="number" id="product-stock" min="0" required>
                    </label>
                </div>

                <div class="grid">
                    <label>
                        Kategori *
                        <input type="text" id="product-category" list="categories-list" required>
                        <datalist id="categories-list">
                            <option value="kurser">
                            <option value="hardware-wallets">
                            <option value="boker">
                            <option value="konsultasjon">
                            <option value="programvare">
                        </datalist>
                    </label>

                    <label>
                        Tags (kommaseparert)
                        <input type="text" id="product-tags" placeholder="bitcoin,kurs,nybegynner">
                    </label>
                </div>

                <label>
                    Bilde-URL
                    <input type="text" id="product-image" placeholder="/uploads/image.jpg">
                </label>

                <label>
                    Last opp bilde
                    <input type="file" id="image-upload" accept="image/*">
                    <small>Maks 5MB. JPG, PNG, GIF eller WebP</small>
                </label>

                <label>
                    <input type="checkbox" id="product-active">
                    Produktet er aktivt (synlig i butikk)
                </label>

                <div style="display: flex; gap: 1rem;">
                    <button type="submit" id="save-btn">Lagre produkt</button>
                    <button type="button" class="secondary" onclick="closeProductModal()">Avbryt</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let products = [];

        // Check authentication
        fetch('/api/admin/check')
            .then(res => res.json())
            .then(data => {
                if (!data.authenticated) {
                    window.location.href = '/admin/';
                }
            });

        async function loadProducts() {
            try {
                const res = await fetch('/api/admin/products');
                products = await res.json();
                renderProducts();
            } catch (error) {
                console.error('Failed to load products:', error);
            }
        }

        function renderProducts() {
            const tbody = document.getElementById('products-tbody');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Ingen produkter enn√•</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(p => `
                <tr>
                    <td>
                        ${p.image_url 
                            ? `<img src="${p.image_url}" class="product-image-thumb" onerror="this.style.display='none'">` 
                            : 'üì¶'
                        }
                    </td>
                    <td><strong>${p.name}</strong><br><small>${p.slug}</small></td>
                    <td>${p.category}</td>
                    <td>${p.price_nok.toFixed(2)}</td>
                    <td>${p.stock}</td>
                    <td>${p.is_active ? '‚úÖ Aktiv' : '‚ùå Inaktiv'}</td>
                    <td>
                        <button class="secondary" onclick="editProduct(${p.id})" style="padding: 0.3rem 0.8rem; margin: 0.2rem;">Rediger</button>
                        <button onclick="deleteProduct(${p.id})" style="padding: 0.3rem 0.8rem; margin: 0.2rem; background: #e74c3c;">Slett</button>
                    </td>
                </tr>
            `).join('');
        }

        function openProductModal(productId = null) {
            document.getElementById('product-modal').style.display = 'block';
            
            if (productId) {
                const product = products.find(p => p.id === productId);
                document.getElementById('modal-title').textContent = 'Rediger produkt';
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-slug').value = product.slug;
                document.getElementById('product-description').value = product.description || '';
                document.getElementById('product-price').value = product.price_nok;
                document.getElementById('product-stock').value = product.stock;
                document.getElementById('product-category').value = product.category;
                document.getElementById('product-tags').value = product.tags || '';
                document.getElementById('product-image').value = product.image_url || '';
                document.getElementById('product-active').checked = product.is_active === 1;
            } else {
                document.getElementById('modal-title').textContent = 'Nytt produkt';
                document.getElementById('product-form').reset();
                document.getElementById('product-id').value = '';
                document.getElementById('product-active').checked = true;
            }
        }

        function closeProductModal() {
            document.getElementById('product-modal').style.display = 'none';
        }

        function editProduct(id) {
            openProductModal(id);
        }

        async function deleteProduct(id) {
            const product = products.find(p => p.id === id);
            if (!confirm(`Er du sikker p√• at du vil slette "${product.name}"?`)) {
                return;
            }

            try {
                const res = await fetch(`/api/admin/products/${id}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    alert('Produkt slettet!');
                    loadProducts();
                } else {
                    const error = await res.json();
                    alert(error.error || 'Kunne ikke slette produkt');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Noe gikk galt');
            }
        }

        // Handle image upload
        document.getElementById('image-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('image', file);

            try {
                const res = await fetch('/api/admin/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await res.json();
                if (res.ok) {
                    document.getElementById('product-image').value = data.imageUrl;
                    alert('Bilde lastet opp!');
                } else {
                    alert(data.error || 'Opplasting mislyktes');
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Kunne ikke laste opp bilde');
            }
        });

        // Handle form submission
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const productId = document.getElementById('product-id').value;
            const isEdit = productId !== '';

            const productData = {
                name: document.getElementById('product-name').value.trim(),
                slug: document.getElementById('product-slug').value.trim(),
                description: document.getElementById('product-description').value.trim(),
                price: parseFloat(document.getElementById('product-price').value),
                stock: parseInt(document.getElementById('product-stock').value),
                category: document.getElementById('product-category').value.trim(),
                tags: document.getElementById('product-tags').value.trim(),
                imageUrl: document.getElementById('product-image').value.trim() || null,
                isActive: document.getElementById('product-active').checked
            };

            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.setAttribute('aria-busy', 'true');

            try {
                const url = isEdit ? `/api/admin/products/${productId}` : '/api/admin/products';
                const method = isEdit ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                if (res.ok) {
                    alert(isEdit ? 'Produkt oppdatert!' : 'Produkt opprettet!');
                    closeProductModal();
                    loadProducts();
                } else {
                    const error = await res.json();
                    alert(error.error || 'Kunne ikke lagre produkt');
                }

            } catch (error) {
                console.error('Save error:', error);
                alert('Noe gikk galt');
            } finally {
                btn.disabled = false;
                btn.removeAttribute('aria-busy');
            }
        });

        async function logout() {
            await fetch('/api/admin/logout', { method: 'POST' });
            window.location.href = '/admin/';
        }

        // Auto-generate slug from name
        document.getElementById('product-name').addEventListener('input', (e) => {
            if (!document.getElementById('product-id').value) {
                const slug = e.target.value.toLowerCase()
                    .replace(/√¶/g, 'ae')
                    .replace(/√∏/g, 'o')
                    .replace(/√•/g, 'a')
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-|-$/g, '');
                document.getElementById('product-slug').value = slug;
            }
        });

        loadProducts();
    </script>
</body>
</html>
